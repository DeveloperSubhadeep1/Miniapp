<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hell King</title>
    <link href="./dist/output.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Updated background for a more Telegram-like feel */
            color: #E0E6F0;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 480px;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Removed height: 100% to let flex-grow on main-content handle height */
        }
        .header {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            color: #E0E6F0;
            z-index: 10;
        }
        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .main-content {
            width: 95%;
            background-color: #2d3748; /* Darker card background */
            border: 1px solid #4a5568;
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-top: 1rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease-in-out;
            animation: fadeIn 0.8s ease-out;
            flex-grow: 1; /* This is the key change, letting it fill available space */
            z-index: 5;
            overflow-y: auto;
        }
        .content-image {
            width: 100%;
            height: auto;
            max-width: 300px;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .content-image:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
        }
        .content-details {
            width: 100%;
            text-align: left;
            margin-top: 1rem;
            padding-right: 0.5rem;
        }
        .content-details p {
            margin-bottom: 0.5rem;
        }
        .content-details .label {
            color: #4a90e2; /* Telegram blue */
            font-weight: 500;
        }
        .genres-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .genre-tag {
            background-color: #2d3748;
            border: 1px solid #4a5568;
            color: #E0E6F0;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
        }
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 1rem;
            padding: 0 1rem;
            z-index: 10;
        }
        .nav-button {
            flex-grow: 1;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            color: white;
            background: #4a90e2; /* Telegram blue */
        }
        .nav-button:disabled {
            background-color: #556070;
            color: #99a2b0;
            cursor: not-allowed;
            box-shadow: none;
        }
        .nav-button.back {
            margin-right: 0.5rem;
        }
        .nav-button.next {
            margin-left: 0.5rem;
        }
        .footer {
            margin-top: 1rem;
            width: 100%;
            text-align: center;
            z-index: 10;
        }
        .search-container {
            display: flex;
            width: 95%;
            gap: 0.5rem;
            margin-bottom: 1rem;
            z-index: 10;
        }
        .search-input {
            flex-grow: 1;
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            color: #E0E6F0;
            outline: none;
            transition: border-color 0.3s;
        }
        .search-input:focus {
            border-color: #4a90e2;
        }
        .search-input::placeholder {
            color: #AAB2BF;
        }
        .search-button {
            background: #4a90e2;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .search-button:disabled {
            background: #556070;
            cursor: not-allowed;
            color: #99a2b0;
        }
        .powered-by {
            font-size: 0.8rem;
            color: #AAB2BF;
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 0.75rem;
            padding: 1.5rem;
            z-index: 1000;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            80% { transform: translate(-50%, -50%) scale(1.05); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }
        .language-selector {
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            padding: 0.25rem 0.5rem;
            color: #E0E6F0;
            outline: none;
            margin-left: 1rem;
        }
        .category-tabs {
            display: flex;
            width: 95%;
            margin-top: 1rem;
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: #2d3748;
            border: 1px solid #4a5568;
            z-index: 10;
        }
        .category-tab {
            flex: 1;
            text-align: center;
            padding: 0.75rem 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            color: #99a2b0;
            background-color: #2d3748;
        }
        .category-tab.active {
            background-color: #4a90e2;
            color: white;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
        }
        .category-tab:not(.active):hover {
            background-color: #3b4554;
        }
        
        /* Skeleton Loading Effect */
        .skeleton {
            animation: pulse 1.5s infinite;
        }
        .skeleton-image {
            width: 100%;
            height: 450px;
            background-color: #4a5568;
            border-radius: 0.5rem;
        }
        .skeleton-text {
            height: 1rem;
            background-color: #4a5568;
            margin: 0.5rem 0;
            border-radius: 4px;
        }
        .skeleton-genres {
            height: 1.5rem;
            width: 70%;
            background-color: #4a5568;
            margin-top: 0.5rem;
            border-radius: 4px;
        }
        @keyframes pulse {
            0% {
                background-color: #4a5568;
            }
            50% {
                background-color: #556070;
            }
            100% {
                background-color: #4a5568;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <span class="header-title" id="header-title"></span>
        <select id="language-selector" class="language-selector">
            <option value="en">English</option>
            <option value="bn">বাংলা</option>
            <option value="hi">हिन्दी</option>
            <option value="ta">தமிழ்</option>
            <option value="te">తెలుగు</option>
        </select>
    </div>
    
    <div class="category-tabs">
        <button id="tab-movies" class="category-tab active">Movies</button>
        <button id="tab-tv" class="category-tab">TV Shows</button>
        <button id="tab-anime" class="category-tab">Anime</button>
    </div>

    <div class="search-container">
        <input type="text" id="search-input" class="search-input" placeholder="Search movies or series...">
        <button id="search-button" class="search-button">
            <!-- Search Icon SVG -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        </button>
    </div>

    <div class="main-content">
        <div id="content-display">
            <img id="poster" class="content-image" src="" alt="Poster">
            <div class="content-details">
                <p><span class="label" id="title-label"></span> <span id="title"></span></p>
                <p><span class="label" id="type-label"></span> <span id="type"></span></p>
                <p><span class="label" id="rating-label"></span> <span id="rating"></span></p>
                <p><span class="label" id="release-date-label"></span> <span id="release-date"></span></p>
                <p><span class="label" id="runtime-label"></span> <span id="runtime"></span></p>
                <p><span class="label" id="genres-label"></span> <span id="genres-container" class="genres-container"></span></p>
                <p class="mt-2"><span class="label" id="storyline-label"></span> <span id="storyline"></span></p>
            </div>
        </div>
        <!-- Skeleton Loader -->
        <div id="skeleton-loader" class="hidden w-full flex flex-col items-center p-4">
            <div class="skeleton skeleton-image"></div>
            <div class="w-full mt-4">
                <div class="skeleton skeleton-text w-3/4"></div>
                <div class="skeleton skeleton-text w-1/2"></div>
                <div class="skeleton skeleton-text w-1/3"></div>
                <div class="skeleton skeleton-genres"></div>
                <div class="skeleton skeleton-text w-full mt-4"></div>
                <div class="skeleton skeleton-text w-full"></div>
                <div class="skeleton skeleton-text w-2/3"></div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <div class="nav-buttons">
            <button id="back-button" class="nav-button back">
                <!-- Back Icon SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
            </button>
            <button id="search-telegram-button" class="nav-button flex-grow-0" style="background-color: #229ED9; margin: 0 0.5rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-telegram"><path d="M22 2 11 13"/><path d="m22 2-7 20-4-9-5-2-9-4Z"/></svg>
            </button>
            <button id="next-button" class="nav-button next">
                <!-- Next Icon SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
            </button>
        </div>
        <p class="powered-by mt-2" id="powered-by-text"></p>
    </div>
</div>

<script>
    const API_KEY = '1c4187f895ad7e2b461e96e3c621c9d3';
    const BASE_URL = 'https://api.themoviedb.org/3';
    const IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/w500';
    const TELEGRAM_BOT_URL = 'https://telegram.me/Hell_King_69_Bot?start=getfile-';
    
    let searchResults = [];
    let currentIndex = 0;
    let currentLanguage = 'en';
    let currentCategory = 'movies';
    let touchStartX = 0;
    const swipeThreshold = 50;

    const languageSelector = document.getElementById('language-selector');
    const searchInput = document.getElementById('search-input');
    const searchButton = document.getElementById('search-button');
    const backButton = document.getElementById('back-button');
    const nextButton = document.getElementById('next-button');
    const searchTelegramButton = document.getElementById('search-telegram-button');
    const mainContent = document.querySelector('.main-content');
    const contentDisplay = document.getElementById('content-display');
    const skeletonLoader = document.getElementById('skeleton-loader');
    const poster = document.getElementById('poster');
    const titleElem = document.getElementById('title');
    const typeElem = document.getElementById('type');
    const ratingElem = document.getElementById('rating');
    const releaseDateElem = document.getElementById('release-date');
    const runtimeElem = document.getElementById('runtime');
    const genresContainer = document.getElementById('genres-container');
    const storylineElem = document.getElementById('storyline');
    
    const tabMovies = document.getElementById('tab-movies');
    const tabTV = document.getElementById('tab-tv');
    const tabAnime = document.getElementById('tab-anime');

    const languageMap = {
        'en': 'en-US',
        'bn': 'bn-BD',
        'hi': 'hi-IN',
        'ta': 'ta-IN',
        'te': 'te-IN'
    };

    const genreMap = new Map();
    let animeGenreId = null;

    const translations = {
        en: {
            headerTitle: 'The Hell King ✨',
            searchPlaceholder: 'Search movies or series...',
            titleLabel: 'Title:',
            typeLabel: 'Type:',
            ratingLabel: 'Rating:',
            releaseDateLabel: 'Release Date:',
            runtimeLabel: 'Runtime:',
            genresLabel: 'Genres:',
            storylineLabel: 'Storyline:',
            movieType: 'Movie 🎬',
            seriesType: 'Series 📺',
            unknown: 'Unknown',
            noStoryline: 'No storyline available.',
            posterNotFound: 'Poster Not Found',
            searchResultsNotFound: 'Sorry, no results were found. Please try a different search.',
            searchPrompt: 'Please enter something to search for.',
            trendingLoadError: 'Failed to load trending content. Please try again later.',
            poweredBy: 'Powered by The Hell King',
            closeButton: 'Close',
            mins: 'minutes',
            minsPerEp: 'mins/ep',
            noTranslatedStoryline: 'No storyline available in this language. Showing original.',
            apiForbiddenError: 'API key error. Your environment may not have a valid API key, or it may have expired.',
            movies: 'Movies',
            tvShows: 'TV Shows',
            anime: 'Anime'
        },
        bn: {
            headerTitle: 'দ্য হেল কিং ✨',
            searchPlaceholder: 'মুভি বা সিরিজ খুঁজুন...',
            titleLabel: 'টাইটেল:',
            typeLabel: 'ধরন:',
            ratingLabel: 'রেটিং:',
            releaseDateLabel: 'রিলিজ ডেট:',
            runtimeLabel: 'রানটাইম:',
            genresLabel: 'জনরা:',
            storylineLabel: 'স্টোরি লাইন:',
            movieType: 'চলচ্চিত্র 🎬',
            seriesType: 'সিরিজ 📺',
            unknown: 'অজানা',
            noStoryline: 'কোনো স্টোরি লাইন নেই।',
            posterNotFound: 'পোস্টার পাওয়া যায়নি',
            searchResultsNotFound: 'দুঃখিত, কোনো ফলাফল পাওয়া যায়নি। অন্য কিছু সার্চ করে দেখুন।',
            searchPrompt: 'অনুসন্ধান করার জন্য কিছু লিখুন।',
            trendingLoadError: 'ট্রেন্ডিং কন্টেন্ট লোড করতে সমস্যা হয়েছে।',
            poweredBy: 'Powered by The Hell King',
            closeButton: 'বন্ধ করুন',
            mins: 'মিনিট',
            minsPerEp: 'মিনিট/এপিসোড',
            noTranslatedStoryline: 'এই ভাষায় কোনো স্টোরি লাইন নেই। মূলটি দেখানো হচ্ছে।',
            apiForbiddenError: 'API key-তে ত্রুটি। আপনার পরিবেশে বৈধ API key নেই, অথবা মেয়াদ শেষ হয়ে গেছে।',
            movies: 'মুভি',
            tvShows: 'ওয়েব সিরিজ',
            anime: 'অ্যানিমে'
        },
        hi: {
            headerTitle: 'द हेल किंग ✨',
            searchPlaceholder: 'मूवी या सीरीज खोजें...',
            titleLabel: 'शीर्षक:',
            typeLabel: 'प्रकार:',
            ratingLabel: 'रेटिंग:',
            releaseDateLabel: 'रिलीज की तारीख:',
            runtimeLabel: 'रनटाइम:',
            genresLabel: 'शैलियाँ:',
            storylineLabel: 'कहानी:',
            movieType: 'फिल्म 🎬',
            seriesType: 'सीरीज 📺',
            unknown: 'अज्ञात',
            noStoryline: 'कोई कहानी उपलब्ध नहीं है।',
            posterNotFound: 'पोस्टर नहीं मिला',
            searchResultsNotFound: 'क्षमा करें, कोई परिणाम नहीं मिला। कृपया कुछ और खोजें।',
            searchPrompt: 'कृपया कुछ लिखें.',
            trendingLoadError: 'ट्रेंडिंग सामग्री लोड करने में विफल।',
            poweredBy: 'Powered by The Hell King',
            closeButton: 'बंद करें',
            mins: 'मिनट',
            minsPerEp: 'मिनट/एपिसोड',
            noTranslatedStoryline: 'इस भाषा में कोई कहानी उपलब्ध नहीं है। मूल दिखाया जा रहा है।',
            apiForbiddenError: 'API key में त्रुटि। आपके वातावरण में वैध API key नहीं हो सकती है, या उसकी समय सीमा समाप्त हो गई है।',
            movies: 'फिल्में',
            tvShows: 'टीवी शोज',
            anime: 'एनीमे'
        },
        ta: {
            headerTitle: 'தி ஹெல் கிங் ✨',
            searchPlaceholder: 'திரைப்படம் அல்லது தொடரை தேடு...',
            titleLabel: 'தலைப்பு:',
            typeLabel: 'வகை:',
            ratingLabel: 'மதிப்பீடு:',
            releaseDateLabel: 'வெளியீட்டு தேதி:',
            runtimeLabel: 'நேரம்:',
            genresLabel: 'வகைகள்:',
            storylineLabel: 'கதைச் சுருக்கம்:',
            movieType: 'திரைப்படம் 🎬',
            seriesType: 'தொடர் 📺',
            unknown: 'தெரியாதது',
            noStoryline: 'கதைச் சுருக்கம் இல்லை.',
            posterNotFound: 'போஸ்டர் கிடைக்கவில்லை',
            searchResultsNotFound: 'மன்னிக்கவும், முடிவுகள் எதுவும் இல்லை. வேறு தேடலை முயற்சிக்கவும்.',
            searchPrompt: 'ஏதாவது உள்ளிடுங்கள்.',
            trendingLoadError: 'பிரபல உள்ளடக்கத்தை ஏற்றுவதில் தோல்வி.',
            poweredBy: 'Powered by The Hell King',
            closeButton: 'மூடு',
            mins: 'நிமிடங்கள்',
            minsPerEp: 'நிமிடங்கள்/அத்தியாயம்',
            noTranslatedStoryline: 'இந்த மொழியில் கதைச்சுருக்கம் இல்லை. அசல் காட்டப்படுகிறது.',
            apiForbiddenError: 'API விசையில் பிழை. உங்கள் சூழலில் சரியான API விசை இல்லாமல் இருக்கலாம் அல்லது அதன் காலாவதி முடிந்துவிட்டது.',
            movies: 'திரைப்படங்கள்',
            tvShows: 'டிவி தொடர்கள்',
            anime: 'அனிமே'
        },
        te: {
            headerTitle: 'ది హెల్ కింగ్ ✨',
            searchPlaceholder: 'సినిమా లేదా సిరీస్ కోసం వెతకండి...',
            titleLabel: 'శీర్షిక:',
            typeLabel: 'రకం:',
            ratingLabel: 'రేటింగ్:',
            releaseDateLabel: 'విడుదల తేదీ:',
            runtimeLabel: 'నడుస్తున్న సమయం:',
            genresLabel: 'శైలులు:',
            storylineLabel: 'కథాంశం:',
            movieType: 'సినిమా 🎬',
            seriesType: 'సిరీస్ 📺',
            unknown: 'తెలియదు',
            noStoryline: 'కథాంశం అందుబాటులో లేదు.',
            posterNotFound: 'పోస్టర్ కనుగొనబడలేదు.',
            searchResultsNotFound: 'క్షమించండి, ఎలాంటి ఫలితాలు లభించలేదు. దయచేసి మరొకటి ప్రయత్నించండి.',
            searchPrompt: 'దయచేసి ఏదైనా వ్రాయండి.',
            trendingLoadError: 'ట్రెండింగ్ కంటెంట్ లోడ్ చేయడంలో విఫలమైంది.',
            poweredBy: 'Powered by The Hell King',
            closeButton: 'మూసివేయండి',
            mins: 'నిమిషాలు',
            minsPerEp: 'నిమిషాలు/ఎపిసోడ్',
            noTranslatedStoryline: 'ఈ భాషలో కథాంశం అందుబాటులో లేదు. అసలు ప్రదర్శించబడుతోంది।',
            apiForbiddenError: 'API కీలో లోపం. మీ వాతావరణంలో చెల్లుబాటు అయ్యే API కీ ఉండకపోవచ్చు లేదా దాని గడువు ముగిసి ఉండవచ్చు.',
            movies: 'సినిమాలు',
            tvShows: 'టీవీ కార్యక్రమాలు',
            anime: 'అనిమే'
        }
    };

    function updateUI() {
        const lang = currentLanguage;
        const t = translations[lang];
        document.getElementById('header-title').textContent = t.headerTitle;
        searchInput.placeholder = t.searchPlaceholder;
        tabMovies.textContent = t.movies;
        tabTV.textContent = t.tvShows;
        tabAnime.textContent = t.anime;
        document.getElementById('title-label').textContent = t.titleLabel;
        document.getElementById('type-label').textContent = t.typeLabel;
        document.getElementById('rating-label').textContent = t.ratingLabel;
        document.getElementById('release-date-label').textContent = t.releaseDateLabel;
        document.getElementById('runtime-label').textContent = t.runtimeLabel;
        document.getElementById('genres-label').textContent = t.genresLabel;
        document.getElementById('storyline-label').textContent = t.storylineLabel;
        document.getElementById('powered-by-text').textContent = t.poweredBy;

        updateNavigationButtons();
    }

    function showMessage(messageKey, titleKey = null) {
        const message = translations[currentLanguage][messageKey] || messageKey;
        const title = translations[currentLanguage][titleKey] || titleKey || '';

        const existingMessageBox = document.querySelector('.message-box');
        if (existingMessageBox) existingMessageBox.remove();

        const messageBox = document.createElement('div');
        messageBox.className = 'message-box';
        let innerHTML = '';
        if (title) {
              innerHTML += `<h3 class="font-bold mb-2">${title}</h3>`;
        }
        innerHTML += `<p>${message}</p>
            <button class="mt-4 px-4 py-2 bg-[#4a90e2] text-white rounded-md font-semibold">${translations[currentLanguage].closeButton}</button>
        `;
        messageBox.innerHTML = innerHTML;
        document.body.appendChild(messageBox);

        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        document.body.appendChild(overlay);

        const closeButton = messageBox.querySelector('button');
        closeButton.addEventListener('click', () => {
            messageBox.remove();
            overlay.remove();
        });
    }
    
    function showLoadingState() {
        contentDisplay.classList.add('hidden');
        skeletonLoader.classList.remove('hidden');
    }

    function hideLoadingState() {
        contentDisplay.classList.remove('hidden');
        skeletonLoader.classList.add('hidden');
    }

    async function fetchGenres() {
        try {
            const response = await fetch(`${BASE_URL}/genre/movie/list?api_key=${API_KEY}&language=en-US`);
            const data = await response.json();
            if (data && data.genres) {
                genreMap.clear();
                data.genres.forEach(genre => {
                    genreMap.set(genre.id, genre.name);
                    if (genre.name === 'Animation') {
                        animeGenreId = genre.id;
                    }
                });
            }
        } catch (error) {
            console.error('Error fetching genres:', error);
        }
    }

    async function fetchContent(category) {
        showLoadingState();
        currentCategory = category;
        let url;
        if (category === 'movies') {
            url = `${BASE_URL}/trending/movie/day?api_key=${API_KEY}&language=${languageMap[currentLanguage]}`;
        } else if (category === 'tv') {
            url = `${BASE_URL}/trending/tv/day?api_key=${API_KEY}&language=${languageMap[currentLanguage]}`;
        } else if (category === 'anime') {
            if (!animeGenreId) {
                showMessage('trendingLoadError', 'Genre data missing');
                hideLoadingState();
                return;
            }
            url = `${BASE_URL}/discover/tv?api_key=${API_KEY}&language=${languageMap[currentLanguage]}&with_genres=${animeGenreId}&sort_by=popularity.desc`;
        }
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data && data.results) {
                searchResults = data.results.filter(item => item.poster_path);
                if (searchResults.length === 0) {
                    showMessage('searchResultsNotFound');
                    mainContent.classList.add('hidden');
                } else {
                    mainContent.classList.remove('hidden');
                }
                currentIndex = 0;
                displayContent(currentIndex);
            } else {
                showMessage('trendingLoadError');
                searchResults = [];
                mainContent.classList.add('hidden');
            }
        } catch (error) {
            console.error('Error fetching content:', error);
            showMessage('trendingLoadError');
            searchResults = [];
            mainContent.classList.add('hidden');
        } finally {
            hideLoadingState();
            updateNavigationButtons();
        }
    }

    async function fetchSearch(query) {
        showLoadingState();
        try {
            const encodedQuery = encodeURIComponent(query);
            const SEARCH_URL = `${BASE_URL}/search/multi?api_key=${API_KEY}&query=${encodedQuery}`;
            const response = await fetch(`${SEARCH_URL}&language=${languageMap[currentLanguage]}`);
            const data = await response.json();
            if (data && data.results) {
                searchResults = data.results.filter(item => (item.media_type === 'movie' || item.media_type === 'tv') && item.poster_path);
                if (searchResults.length === 0) {
                    showMessage('searchResultsNotFound');
                    mainContent.classList.add('hidden');
                } else {
                    mainContent.classList.remove('hidden');
                }
                currentIndex = 0;
                displayContent(currentIndex);
            } else {
                showMessage('searchResultsNotFound');
                searchResults = [];
                mainContent.classList.add('hidden');
            }
        } catch (error) {
            console.error('Error fetching search results:', error);
            showMessage('searchResultsNotFound');
            searchResults = [];
            mainContent.classList.add('hidden');
        } finally {
            hideLoadingState();
            updateNavigationButtons();
        }
    }

    async function fetchDetails(id, type) {
        try {
            const response = await fetch(`${BASE_URL}/${type}/${id}?api_key=${API_KEY}&language=${languageMap[currentLanguage]}`);
            return await response.json();
        } catch (error) {
            console.error('Error fetching details:', error);
            return null;
        }
    }

    async function displayContent(index) {
        if (searchResults.length === 0) {
            mainContent.classList.add('hidden');
            return;
        }

        mainContent.classList.remove('hidden');
        const content = searchResults[index];
        
        const translatedDetails = await fetchDetails(content.id, content.media_type);

        let displayedOverview = content.overview;
        if (translatedDetails && translatedDetails.overview) {
            displayedOverview = translatedDetails.overview;
        } else if (!content.overview) {
            displayedOverview = translations[currentLanguage].noStoryline;
        }
        storylineElem.textContent = displayedOverview;

        poster.src = content.poster_path ? `${IMAGE_BASE_URL}${content.poster_path}` : 'https://placehold.co/500x750?text=' + translations[currentLanguage].posterNotFound.replace(/ /g, '+');
        titleElem.textContent = content.title || content.name || translations[currentLanguage].unknown;
        typeElem.textContent = content.media_type === 'movie' ? translations[currentLanguage].movieType : translations[currentLanguage].seriesType;
        ratingElem.textContent = content.vote_average ? `${content.vote_average.toFixed(2)} / 10` : translations[currentLanguage].unknown;
        releaseDateElem.textContent = content.release_date || content.first_air_date || translations[currentLanguage].unknown;
        runtimeElem.textContent = translations[currentLanguage].unknown;

        if (translatedDetails) {
            if (content.media_type === 'movie' && translatedDetails.runtime) {
                runtimeElem.textContent = `${translatedDetails.runtime} ${translations[currentLanguage].mins}`;
            } else if (content.media_type === 'tv' && translatedDetails.episode_run_time && translatedDetails.episode_run_time.length > 0) {
                runtimeElem.textContent = `${translatedDetails.episode_run_time[0]} ${translations[currentLanguage].minsPerEp}`;
            } else {
                runtimeElem.textContent = translations[currentLanguage].unknown;
            }
        }

        genresContainer.innerHTML = '';
        if (translatedDetails && translatedDetails.genres && translatedDetails.genres.length > 0) {
            translatedDetails.genres.forEach(genre => {
                const span = document.createElement('span');
                span.className = 'genre-tag';
                span.textContent = genre.name;
                genresContainer.appendChild(span);
            });
        } else if (content.genre_ids && content.genre_ids.length > 0) {
            content.genre_ids.forEach(genreId => {
                const genreName = genreMap.get(genreId) || translations[currentLanguage].unknown;
                const span = document.createElement('span');
                span.className = 'genre-tag';
                span.textContent = genreName;
                genresContainer.appendChild(span);
            });
        } else {
            const span = document.createElement('span');
            span.textContent = translations[currentLanguage].unknown;
            genresContainer.appendChild(span);
        }
    }

    function updateNavigationButtons() {
        const hasResults = searchResults.length > 0;
        backButton.disabled = !hasResults || currentIndex === 0;
        nextButton.disabled = !hasResults || currentIndex === searchResults.length - 1;
        searchButton.disabled = false;
    }

    function disableAllButtons() {
        backButton.disabled = true;
        nextButton.disabled = true;
        searchButton.disabled = true;
    }
    
    function setActiveTab(tab) {
        document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
        if (tab) {
            tab.classList.add('active');
        }
    }
    
    // Swipe Gestures
    mainContent.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
    });

    mainContent.addEventListener('touchmove', (e) => {
        // This is important to prevent scrolling while swiping
        e.preventDefault();
    });

    mainContent.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].clientX;
        const swipeDistance = touchEndX - touchStartX;
        
        if (swipeDistance > swipeThreshold) {
            // Swiped right (previous)
            backButton.click();
        } else if (swipeDistance < -swipeThreshold) {
            // Swiped left (next)
            nextButton.click();
        }
    });

    languageSelector.addEventListener('change', (event) => {
        currentLanguage = event.target.value;
        updateUI();
        fetchContent(currentCategory);
    });
    
    tabMovies.addEventListener('click', () => {
        setActiveTab(tabMovies);
        fetchContent('movies');
    });

    tabTV.addEventListener('click', () => {
        setActiveTab(tabTV);
        fetchContent('tv');
    });
    
    tabAnime.addEventListener('click', () => {
        setActiveTab(tabAnime);
        fetchContent('anime');
    });

    searchButton.addEventListener('click', () => {
        const query = searchInput.value.trim();
        if (query) {
            setActiveTab(null);
            disableAllButtons();
            fetchSearch(query);
        } else {
            showMessage('searchPrompt');
        }
    });

    searchTelegramButton.addEventListener('click', () => {
        if (searchResults.length > 0) {
            const currentTitle = searchResults[currentIndex].title || searchResults[currentIndex].name;
            if (currentTitle) {
                const formattedTitle = currentTitle.replace(/[^\w\s]/gi, '').replace(/\s+/g, '-').toLowerCase();
                const telegramUrl = `${TELEGRAM_BOT_URL}${formattedTitle}`;
                window.open(telegramUrl, '_blank');
            }
        }
    });

    backButton.addEventListener('click', () => {
        if (currentIndex > 0) {
            currentIndex--;
            displayContent(currentIndex);
            updateNavigationButtons();
        }
    });

    nextButton.addEventListener('click', () => {
        if (currentIndex < searchResults.length - 1) {
            currentIndex++;
            displayContent(currentIndex);
            updateNavigationButtons();
        }
    });

    searchInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            searchButton.click();
        }
    });

    window.onload = () => {
        fetchGenres();
        languageSelector.value = 'en';
        updateUI();
        fetchContent('movies');
    };

</script>

</body>
</html>
